/*! mmdAvatar 0.0.1 2017-01-09  WaterTian */
function isMobileDevice(){if(void 0===navigator||void 0===navigator.userAgent)return!0;var a=navigator.userAgent;return!!(a.match(/iPhone/i)||a.match(/iPad/i)||a.match(/iPod/i)||a.match(/webOS/i)||a.match(/BlackBerry/i)||a.match(/Windows/i)&&a.match(/Phone/i)||a.match(/Android/i)&&a.match(/Mobile/i))}function init(){function a(){o.loadVmds(n,function(a){for(var c=a,d=0;d<c.length;d++)o.pourVmdIntoModel(mesh,c[d]);avatar.TYsetAnimation(mesh),avatar.TYsetikSolver(mesh),b(),console.log(mesh),console.log(avatar),loading.style.display="none"},k,l)}function b(){c(),e()}function c(){for(var a in mesh.morphTargetDictionary)for(var b=0;b<=TY.morphConifg.length;b++)a==TY.morphConifg[b]&&p.push(b);console.log(p)}function d(a){if(a.length==p.length)return console.log("configControlDate Return"),a;for(var b=[],c=0;c<a.length;c++)for(var d=0;d<p.length;d++)c==p[d]&&b.push(a[c]);return b}function e(){q>=TY.data.length&&(q=0),setTimeout(e,1e3),f(TY.data[q]),q++}function f(a){var b=d(a),c=TY.toObject(b);new TWEEN.Tween(s).to(c,200).start().onUpdate(function(){for(var a=0;a<b.length;a++)mesh.morphTargetInfluences[a]=this[a]})}container=document.createElement("div"),document.body.appendChild(container),camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,1,2e3),camera.position.z=25,scene=new THREE.Scene;var g=new THREE.PolarGridHelper(30,10);g.position.y=-10,scene.add(g);var h=new THREE.AmbientLight(3355443);scene.add(h);var i=new THREE.DirectionalLight(8947848);i.position.set(-1,1,1).normalize(),scene.add(i),renderer=new THREE.WebGLRenderer({antialias:!0}),renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth,window.innerHeight),renderer.setClearColor(new THREE.Color(16777215)),container.appendChild(renderer.domElement),TY.effect=new THREE.OutlineEffect(renderer),logBox=document.createElement("div"),logBox.style.position="absolute",logBox.style.top="90px",logBox.style.width="100%",logBox.style.textAlign="left",logBox.innerHTML="...",container.appendChild(logBox),TY.logBox=logBox,controls=new THREE.TyOrbitControls(camera,renderer.domElement),controls.target.set(0,0,0),controls.update(),loading=document.createElement("div"),loading.style.position="absolute",loading.style.top="60px",loading.style.width="100%",loading.style.textAlign="center",loading.innerHTML="Loading..",container.appendChild(loading),stats=new Stats,container.appendChild(stats.dom);var j=document.createElement("div");j.style.position="absolute",j.style.top="30px",j.style.width="100%",j.style.textAlign="center",j.innerHTML='Action:<input type="button" onclick="action1();" value="action1" />\t    <input type="button" onclick="action2();" value="action2" />\t\t<input type="button" onclick="action3();" value="action3" />',container.appendChild(j);var k=function(a){if(a.lengthComputable){var b=a.loaded/a.total*100,c="loading "+Math.round(b,2);console.log(c),loading.innerHTML=c}},l=function(a){},m="models/low_miku/miku.pmd",n=["motion/nof_motion/nof_haku.vmd","motion/kishimen.vmd","motion/wavefile_full_miku_v2.vmd"];avatar=new TY.MMDAvatar(scene);var o=new THREE.MMDLoader;o.loadModel(m,function(b){avatar.add(b),mesh=avatar.mesh,mesh.position.y=-10,avatar.initIk(),avatar.initPhysic(),TY.Gui(avatar),a()},k,l);var p=[],q=0,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],s=TY.toObject(r);window.addEventListener("resize",onWindowResize,!1)}function action1(){avatar.TYfadeToAction(mesh,mesh.geometry.animations[0],.5,1,.5)}function action2(){avatar.TYfadeToAction(mesh,mesh.geometry.animations[1],.5,1,.15)}function action3(){avatar.TYfadeToAction(mesh,mesh.geometry.animations[2],1,1,.4)}function onWindowResize(){windowHalfX=window.innerWidth/2,windowHalfY=window.innerHeight/2,camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),TY.effect.setSize(window.innerWidth,window.innerHeight)}function animate(a){requestAnimationFrame(animate),render(),TWEEN.update(a),stats&&stats.update()}function render(){void 0!==avatar&&avatar.animate(clock.getDelta()),TY.effect.render(scene,camera)}this.TY=this.TY||{},TY.VERSION="0",TY.Debug=0,TY.data=[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0],[0,0,0,0,0,0,0,0,.1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.9,0,0],[0,0,0,0,0,0,0,0,.2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.6,0,0],[0,0,0,0,0,0,0,0,.4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.5,0,0],[0,0,0,0,0,0,0,0,.6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.4,0,0],[0,0,0,0,0,0,0,0,.7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.3,0,0],[0,0,0,0,0,0,0,0,.9,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.2,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,.7,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,.4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],TY.morphConifg={length:30,1:"真面目",2:"困る",3:"にこり",4:"怒り",5:"上",6:"下",7:"まばたき",8:"笑い",9:"ウィンク",10:"ウィンク２",11:"ウィンク右",12:"ｳｨﾝｸ２右",13:"はぅ",14:"なごみ",15:"びっくり",16:"じと目",17:"なぬ！",18:"瞳小",19:"あ",20:"い",21:"う",22:"お",23:"▲",24:"∧",25:"ω",26:"ω□",27:"はんっ！",28:"ぺろっ",29:"えー",30:"にやり"},TY.inherit=function(a,b){a.superClass=b,a.prototype=Object.create(b.prototype),a.prototype.constructor=a},TY.extend=function(a,b){if(!b||"object"!=typeof b)return a;for(var c=Object.keys(b),d=c.length;d--;)a[c[d]]=b[c[d]];return a},TY.dpr=window.devicePixelRatio||1,TY.isAndroid=/Android/i.test(navigator.userAgent),TY.isIphone=/iphone/i.test(navigator.userAgent),TY.isChrome=/chrome\//i.test(navigator.userAgent),TY.isWeixin=/MicroMessenger\//i.test(navigator.userAgent),TY.isWeibo=/Weibo/i.test(navigator.userAgent),TY.isMobileDevice=isMobileDevice,TY.toObject=function(a){for(var b={},c=0;c<a.length;++c)b[c]=a[c];return b},TY.EventDispatcher=function(){},TY.EventDispatcher.prototype={constructor:TY.EventDispatcher,addEventListener:function(a,b){return this._listeners?this.removeEventListener(a,b):this._listeners={},this._listeners[a]||(this._listeners[a]=[]),this._listeners[a].push(b),b},hasEventListener:function(a,b){var c=this._listeners;return!(!c||!c[a])},removeEventListener:function(a,b){if(this._listeners&&this._listeners[a])for(var c=this._listeners[a],d=0,e=c.length;d<e;d++)if(c[d]==b){1==e?delete this._listeners[a]:c.splice(d,1);break}},removeAllEventListeners:function(a){a?this._listeners&&delete this._listeners[a]:this._listeners=null},dispatchEvent:function(a,b){var c=!1,d=this._listeners;if(a&&d){var e=d[a];if(!e)return c;e=e.slice();for(var f,g=e.length;g--;){var f=e[g];c=c||f(b)}}return!!c}},TY.MMDAvatar=function(a){this.scene=a,this.mesh=null,this.meshes=[],this.doAnimation=!0,this.doIk=!0,this.doGrant=!0,this.doPhysics=!0,this.doCameraAnimation=!0,this.sharedPhysics=!1,this.masterPhysics=null,this.audioManager=null,this.camera=null,this.ikHelper,this.physicsHelper,this.currentAction=null},TY.MMDAvatar.prototype=Object.assign(TY.EventDispatcher.prototype,{constructor:TY.MMDAvatar,add:function(a){if(!(a instanceof THREE.SkinnedMesh))throw new Error("THREE.MMDHelper.add() accepts only THREE.SkinnedMesh instance.");void 0===a.mixer&&(a.mixer=null),void 0===a.ikSolver&&(a.ikSolver=null),void 0===a.grantSolver&&(a.grantSolver=null),void 0===a.physics&&(a.physics=null),void 0===a.looped&&(a.looped=!1),this.mesh=a,this.meshes.push(a),this.initBackupBones(a),this.scene.add(this.mesh)},initIk:function(){this.ikHelper=new THREE.CCDIKHelper(this.mesh),this.ikHelper.visible=!1,this.scene.add(this.ikHelper)},initPhysic:function(){this.setPhysics(this.mesh),this.physicsHelper=new THREE.MMDPhysicsHelper(this.mesh),this.physicsHelper.visible=!1,this.scene.add(this.physicsHelper),TY.isMobileDevice&&this.enablePhysics(!1)},setAudio:function(a,b,c){this.audioManager=new THREE.MMDAudioManager(a,b,c)},setCamera:function(a){a.mixer=null,this.camera=a},setPhysicses:function(a){for(var b=0;b<this.meshes.length;b++)this.setPhysics(this.meshes[b],a)},setPhysics:function(a,b){if(b=void 0===b?{}:Object.assign({},b),void 0===b.world&&this.sharedPhysics){var c=this.getMasterPhysics();null!==c&&(b.world=c.world)}var d=void 0!==b.warmup?b.warmup:60,e=new THREE.MMDPhysics(a,b);null!==a.mixer&&void 0!==a.mixer&&b.preventAnimationWarmup!==!0&&(this.animateOneMesh(0,a),e.reset()),e.warmup(d),this.updateIKParametersDependingOnPhysicsEnabled(a,!0),a.physics=e},getMasterPhysics:function(){if(null!==this.masterPhysics)return this.masterPhysics;for(var a=0,b=this.meshes.length;a<b;a++){var c=this.meshes[a].physics;if(void 0!==c&&null!==c)return this.masterPhysics=c,this.masterPhysics}return null},enablePhysics:function(a){a===!0?this.doPhysics=!0:this.doPhysics=!1;for(var b=0,c=this.meshes.length;b<c;b++)this.updateIKParametersDependingOnPhysicsEnabled(this.meshes[b],a)},updateIKParametersDependingOnPhysicsEnabled:function(a,b){for(var c=a.geometry.iks,d=a.geometry.bones,e=0,f=c.length;e<f;e++)for(var g=c[e],h=g.links,i=0,j=h.length;i<j;i++){var k=h[i];b===!0?k.enabled=!(d[k.index].rigidBodyType>0):k.enabled=!0}},setAnimations:function(){for(var a=0;a<this.meshes.length;a++)this.setAnimation(this.meshes[a])},setAnimation:function(a){if(void 0!==a.geometry.animations){a.mixer=new THREE.AnimationMixer(a),a.mixer.addEventListener("loop",function(a){if(0===a.action._clip.tracks[0].name.indexOf(".bones")){var b=a.target._root;b.looped=!0}});for(var b=!1,c=!1,d=0;d<a.geometry.animations.length;d++){var e=a.geometry.animations[d],f=a.mixer.clipAction(e);0===e.tracks[0].name.indexOf(".morphTargetInfluences")?c||(f.play(),c=!0):b||(f.play(),b=!0)}b&&(a.ikSolver=new THREE.CCDIKSolver(a),void 0!==a.geometry.grants&&(a.grantSolver=new THREE.MMDGrantSolver(a)))}},TYsetAnimation:function(a){void 0!==a.geometry.animations&&(a.mixer=new THREE.AnimationMixer(a),a.mixer.addEventListener("loop",function(a){if(0===a.action._clip.tracks[0].name.indexOf(".bones")){var b=a.target._root;b.looped=!0}}))},TYsetikSolver:function(a){a.ikSolver=new THREE.CCDIKSolver(a),void 0!==a.geometry.grants&&(a.grantSolver=new THREE.MMDGrantSolver(a))},TYplayAction:function(a,b,c){var d=a.mixer.clipAction(b);return d.setEffectiveWeight(c),d.play(),d},TYgotoAndPlayAction:function(a,b,c,d){var e=a.mixer.clipAction(b);return e.setEffectiveWeight(c),e.time=.5*b.duration*d,e.play(),e},TYfadeToAction:function(a,b,c,d,e){var f=this;if(this.currentAction!=a.mixer.clipAction(b)){var g=this.TYgotoAndPlayAction(a,b,d,e);if(!this.currentAction)return void(this.currentAction=g);this.currentAction.crossFadeTo(g,c,!1),setTimeout(function(){f.currentAction.stop(),f.currentAction=g},1e3*c)}},setCameraAnimation:function(a){void 0!==a.animations&&(a.mixer=new THREE.AnimationMixer(a),a.mixer.clipAction(a.animations[0]).play())},unifyAnimationDuration:function(a){a=void 0===a?{}:a;for(var b=0,c=this.camera,d=this.audioManager,e=0;e<this.meshes.length;e++){var f=this.meshes[e],g=f.mixer;if(null!==g)for(var h=0;h<g._actions.length;h++){var i=g._actions[h];b=Math.max(b,i._clip.duration)}}if(null!==c&&null!==c.mixer)for(var g=c.mixer,e=0;e<g._actions.length;e++){var i=g._actions[e];b=Math.max(b,i._clip.duration)}null!==d&&(b=Math.max(b,d.duration)),void 0!==a.afterglow&&(b+=a.afterglow);for(var e=0;e<this.meshes.length;e++){var f=this.meshes[e],g=f.mixer;if(null!==g)for(var h=0;h<g._actions.length;h++){var i=g._actions[h];i._clip.duration=b}}if(null!==c&&null!==c.mixer)for(var g=c.mixer,e=0;e<g._actions.length;e++){var i=g._actions[e];i._clip.duration=b}null!==d&&(d.duration=b)},controlAudio:function(a){null!==this.audioManager&&this.audioManager.control(a)},animate:function(a){this.controlAudio(a);for(var b=0;b<this.meshes.length;b++)this.animateOneMesh(a,this.meshes[b]);this.sharedPhysics&&this.updateSharedPhysics(a),void 0!==this.physicsHelper&&this.physicsHelper.visible&&this.physicsHelper.update(),void 0!==this.ikHelper&&this.ikHelper.visible&&this.ikHelper.update()},animateOneMesh:function(a,b){var c=b.mixer,d=b.ikSolver,e=b.grantSolver,f=b.physics;null!==c&&this.doAnimation===!0&&(this.restoreBones(b),c.update(a),this.backupBones(b)),null!==d&&this.doIk===!0&&d.update(),null!==e&&this.doGrant===!0&&e.update(),b.looped===!0&&(null!==f&&f.reset(),b.looped=!1),null!==f&&this.doPhysics&&!this.sharedPhysics&&f.update(a)},updateSharedPhysics:function(a){if(0!==this.meshes.length&&this.doPhysics&&this.sharedPhysics){var b=this.getMasterPhysics();if(null!==b){for(var c=0,d=this.meshes.length;c<d;c++){var e=this.meshes[c].physics;null!==e&&void 0!==e&&e.updateRigidBodies()}b.stepSimulation(a);for(var c=0,d=this.meshes.length;c<d;c++){var e=this.meshes[c].physics;null!==e&&void 0!==e&&e.updateBones()}}}},animateCamera:function(a){if(null!==this.camera){var b=this.camera.mixer;null!==b&&void 0!==this.camera.center&&this.doCameraAnimation===!0&&(b.update(a),this.camera.updateProjectionMatrix(),this.camera.up.set(0,1,0),this.camera.up.applyQuaternion(this.camera.quaternion),this.camera.lookAt(this.camera.center))}},poseAsVpd:function(a,b,c){void 0===c&&(c={}),c.preventResetPose!==!0&&a.pose();for(var d=a.skeleton.bones,e=b.bones,f={},g=0;g<d.length;g++)f[d[g].name]=g;for(var h=new THREE.Vector3,i=new THREE.Quaternion,g=0;g<e.length;g++){var j=e[g],k=f[j.name];if(void 0!==k){var l=d[k],m=j.translation,n=j.quaternion;h.set(m[0],m[1],m[2]),i.set(n[0],n[1],n[2],n[3]),l.position.add(h),l.quaternion.multiply(i)}}if(a.updateMatrixWorld(!0),c.preventIk!==!0){var o=new THREE.CCDIKSolver(a);o.update(c.saveOriginalBonesBeforeIK)}if(c.preventGrant!==!0&&void 0!==a.geometry.grants){var o=new THREE.MMDGrantSolver(a);o.update()}},initBackupBones:function(a){a.skeleton.backupBones=[];for(var b=0;b<a.skeleton.bones.length;b++)a.skeleton.backupBones.push(a.skeleton.bones[b].clone())},backupBones:function(a){a.skeleton.backupBoneIsSaved=!0;for(var b=0;b<a.skeleton.bones.length;b++){var c=a.skeleton.backupBones[b],d=a.skeleton.bones[b];c.position.copy(d.position),c.quaternion.copy(d.quaternion)}},restoreBones:function(a){if(a.skeleton.backupBoneIsSaved===!0){a.skeleton.backupBoneIsSaved=!1;for(var b=0;b<a.skeleton.bones.length;b++){var c=a.skeleton.bones[b],d=a.skeleton.backupBones[b];c.position.copy(d.position),c.quaternion.copy(d.quaternion)}}}}),TY.Gui=function(a){function b(a){for(var b=[],c=0,d=a.length;c<d;c++){var e=new THREE.MeshPhongMaterial;e.copy(a[c]),e.needsUpdate=!0,b.push(e)}h=new THREE.MultiMaterial(b)}function c(){for(var a in l)m[a]=0}function d(){for(var a in l)n.push(a)}function e(){for(var a in l)o.add(m,a,0,1,.01).onChange(f)}function f(){for(var a=0;a<n.length;a++){var b=n[a],c=m[b];j.morphTargetInfluences[a]=c}}function g(){var c={animation:!0,"gradient mapping":!0,ik:!0,outline:!0,physics:!0,"show IK bones":!1,"show rigid bodies":!1};k.add(c,"animation").onChange(function(){a.doAnimation=c.animation}),k.add(c,"gradient mapping").onChange(function(){void 0===i&&(i=j.material),void 0===h&&b(j.material.materials),c["gradient mapping"]?j.material=i:j.material=h}),k.add(c,"ik").onChange(function(){a.doIk=c.ik}),k.add(c,"outline").onChange(function(){TY.effect.enabled=c.outline}),k.add(c,"physics").onChange(function(){a.enablePhysics(c.physics)}),k.add(c,"show IK bones").onChange(function(){a.ikHelper.visible=c["show IK bones"]}),k.add(c,"show rigid bodies").onChange(function(){void 0!==a.physicsHelper&&(a.physicsHelper.visible=c["show rigid bodies"])})}var h,i,j=a.mesh,k=new dat.GUI,l=j.morphTargetDictionary,m={},n=[],o=k.addFolder("Morphs");c(),d(),e(),g(),f(),o.close(),k.close()},TY.Gui.prototype=Object.assign(TY.EventDispatcher.prototype,{constructor:TY.Gui});var container,stats,loading,mesh,camera,scene,renderer,avatar,clock=new THREE.Clock;init(),animate();